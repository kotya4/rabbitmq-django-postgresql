{% load static %}

<link rel="stylesheet" type="text/css" href="{% static 'polls/style.css' %}">
<link rel="shortcut icon" type="image/png" href="{% static 'favicon.ico' %}"/>










<button id="btn-update">Обновить</button>
<button id="btn-add">Добавить</button>
<button id="btn-test">test</button>
<div id="txt-btn-add-status" style="color:red"></div>









<div id="wra-func">
  <textarea id="ta-func-textual" placeholder="функция"></textarea>
  <textarea id="ta-func-dt" placeholder="dt"></textarea>
  <textarea id="ta-func-interval" placeholder="interval"></textarea>
</div>











<div id="wra-content"></div>








<script type="text/javascript">













  // django needs token placed by him in cookies to make ajax stuff
  const csrftoken = document.cookie.split ( ';' ) .map ( e => e.split ( '=' ) ) .find ( e => e[ 0 ] === 'csrftoken' )[ 1 ]











  document.querySelector ( '#btn-update' )
    .addEventListener ( 'click', () => {

      post_updatefuncs ()

    } )





  document.querySelector ( '#btn-test' )
    .addEventListener ( 'click', () => {

      post_newfunc ( 'test' + Date.now (), 1, 1 )

    } )





  document.querySelector ( '#btn-add' )
    .addEventListener ( 'click', () => {

      const inputs =
        [ document.querySelector ( '#ta-func-textual' )
        , document.querySelector ( '#ta-func-dt' )
        , document.querySelector ( '#ta-func-interval' )
        ]

      post_newfunc ( ... inputs.map ( e => e.value ) )

      inputs.forEach ( e => e.value = '' )

    } )











function post_newfunc ( textual, dt, interval ) {

  const status = document.querySelector ( '#txt-btn-add-status' )
  status.innerText = ''

  if ( textual && dt && interval ) {

    const r = { newfunc: { textual, dt, interval } }

    const ajax = new XMLHttpRequest ()
    ajax.open ( 'POST', '/' )
    ajax.setRequestHeader ( 'Content-type', 'application/json; charset=utf-8' )
    ajax.setRequestHeader ( 'X-CSRFToken', csrftoken )
    ajax.send ( JSON.stringify ( r ) )
    ajax.addEventListener ( 'readystatechange', () => {
      if ( ajax.readyState === XMLHttpRequest.DONE && ajax.status === 200 ) {

        parse_server_response ( ajax.response, 'post_newfunc' )

      }
    } )

  }

  else {

    status.innerText = 'post_newfunc :: ' + 'textual and dt and interval must be filled properly'

  }

}





function post_updatefuncs () {

  const status = document.querySelector ( '#txt-btn-add-status' )
  status.innerText = ''

  const r = { updatefuncs: 1 }

  const ajax = new XMLHttpRequest ()
  ajax.open ( 'POST', '/' )
  ajax.setRequestHeader ( 'Content-type', 'application/json; charset=utf-8' )
  ajax.setRequestHeader ( 'X-CSRFToken', csrftoken )
  ajax.send ( JSON.stringify ( r ) )
  ajax.addEventListener ( 'readystatechange', () => {
    if ( ajax.readyState === XMLHttpRequest.DONE && ajax.status === 200 ) {

      parse_server_response ( ajax.response, 'post_updatefuncs' )

    }
  } )



}









function parse_server_response ( r, calling='' ) {

  const status = document.querySelector ( '#txt-btn-add-status' )
  status.innerText = ''

  try {

    r = JSON.parse ( r )

    if ( 'updatefuncs' in r ) {

      const content = document.querySelector ( '#wra-content' )

      content.innerHTML = ''

      for ( let f of r[ 'updatefuncs' ].reverse () ) {

        content.append ( func_node ( f ) )

      }

    }

  } catch ( e ) {

    status.innerText = calling + r

  }


}




function func_node ( { id, textual, dt, interval, image, exception, datetime } ) {

  const a = document.createElement ( 'span' )
  a.innerText = JSON.stringify ( { id, textual, dt, interval, datetime } )

  const b = document.createElement ( 'span' )

  if ( image ) {

    img = new Image ()
    img.src = 'data:image/png;base64,' + image
    b.append ( img )

  } else if ( exception ) {

    b.style.color = 'hotpink'
    b.innerText = exception

  } else {

    b.style.color = 'lightblue'
    b.innerText = 'in queue'

  }

  const w = document.createElement ( 'div' )
  w.append ( a, b )
  return w

}




</script>
